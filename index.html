<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main Page</title>
    <link rel="stylesheet" href="index.css" />
</head>
<body>

    <a href="recipe.html">
        <img src="image/cip.gif" class="cute_thing" id="cute_thing" alt="Cute character" title="Click for Recipes!" style="cursor: pointer;">
    </a>
    <audio id="koi_audio" src="sounds/Koi.MP3" loop></audio>

    <div class="recipe-container">
        <h1>What would you like to make today?</h1>
        
        <div class="results-grid">
            <!-- Fried Rice -->
            <a href="menu1/menu1.html" class="recipe-card">
                <img src="image/frying_pan_fried_rice.png" alt="Fried Rice">
                <div class="recipe-info">
                    <h3>Fried Rice</h3>
                    <p>Classic favorite!</p>
                </div>
            </a>

            <!-- Placeholder Menu 2 -->
            <a href="menu2/menu2.html" class="recipe-card">
                <img src="image/plate_burger_fries.png" alt="Menu 2">
                <div class="recipe-info">
                    <h3>Menu Option 2</h3>
                    <p>Coming Soon</p>
                </div>
            </a>

            <!-- Placeholder Menu 3 -->
            <a href="menu1/menu1.html" class="recipe-card">
                <img src="image/wave.png" alt="Menu 3">
                <div class="recipe-info">
                    <h3>Menu Option 3</h3>
                    <p>Coming Soon</p>
                </div>
            </a>

            <!-- Placeholder Menu 4 -->
            <a href="menu1/menu1.html" class="recipe-card">
                <img src="image/wave.png" alt="Menu 4">
                <div class="recipe-info">
                    <h3>Menu Option 4</h3>
                    <p>Coming Soon</p>
                </div>
            </a>

            <!-- Placeholder Menu 5 -->
            <a href="menu1/menu1.html" class="recipe-card">
                <img src="image/wave.png" alt="Menu 5">
                <div class="recipe-info">
                    <h3>Menu Option 5</h3>
                    <p>Coming Soon</p>
                </div>
            </a>

            <!-- Placeholder Menu 6 -->
            <a href="menu1/menu1.html" class="recipe-card">
                <img src="image/wave.png" alt="Menu 6">
                <div class="recipe-info">
                    <h3>Menu Option 6</h3>
                    <p>Coming Soon</p>
                </div>
            </a>
        </div>
    </div>

    <div class="movable_window" aria-label="Movable menu">
        <div class="menu_header small">
            <h2>.<span>L</span>ogin</h2>
        </div>  
        <div class="menu_body small">
            <div class="login">
                <input type="text" placeholder="Username" id="username_id" />
                <div style="display: flex; gap: 10px; width: 100%;">
                    <input type="button" value="Start" id="start_button" style="flex: 1;" />
                    <input type="button" value="üèÜ Scores" id="score_button" style="flex: 1; background: #ffbd2e;" />
                </div>
            </div>
        </div>
    </div>

    <!-- Scoreboard Modal -->
    <div id="score_modal" style="
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    ">
        <div style="
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        ">
            <span id="close_score" style="
                position: absolute;
                top: 15px; right: 20px;
                font-size: 24px;
                cursor: pointer;
                font-weight: bold;
                color: #888;
            ">&times;</span>
            
            <h2 style="margin-bottom: 20px; color: #333;">üèÜ Global Scoreboard</h2>
            
            <div id="score_list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Scores will be injected here -->
                <p>Loading...</p>
            </div>
        </div>
    </div>

<script>

    window.addEventListener("click", () => {const click = new Audio("sounds/Click_Sound_Effect.mp3"); click.play(); });
    // Toggle gif and audio on cute_thing click
    const cuteThing = document.getElementById('cute_thing');
    const koiAudio = document.getElementById('koi_audio');
    
    // login + save to backend
    const startBtn = document.getElementById('start_button');
    const usernameInput = document.getElementById('username_id');
    const movableWindow = document.querySelector('.movable_window');

    if (!startBtn || !usernameInput) {
        console.error("Missing start button or username input");
    } else {
        startBtn.addEventListener('click', async () => {

            koiAudio.play().catch(e => console.log("Audio play blocked:", e));

            const username = usernameInput.value.trim();
            const Time = new Date().toLocaleString();
            console.log(`Username: ${username}, Time: ${Time}`);

            // Fade out window immediately
            if (movableWindow) {
                movableWindow.style.transition = "opacity 0.3s ease";
                movableWindow.style.opacity = "0";

                setTimeout(() => {
                    movableWindow.style.display = 'none';
                }, 300);
            }

            // Backend request (non-blocking)
            try {
                const res = await fetch(
                    "/userLogin.php",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            username: username,
                            time: new Date().toISOString()
                        })
                    }
                );

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                console.log("Saved:", data);

            } catch (err) {
                console.error("Save failed:", err);
            }
        });
    }

    // make movable window draggable
    if (movableWindow) {
        const menu_header = movableWindow.querySelector('.menu_header');
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;

        if (menu_header) {
            menu_header.addEventListener('mousedown', (e) => {
                isDragging = true;
                
                // Get current visual position BEFORE removing transform
                const r = movableWindow.getBoundingClientRect();
                
                // Disable transition to prevent lag/sliding
                movableWindow.style.transition = 'none';

                // Remove transform (which centers it) and set absolute top/left
                // to match the current visual position exactly.
                movableWindow.style.transform = 'none';
                movableWindow.style.left = r.left + 'px';
                movableWindow.style.top = r.top + 'px';

                // Calculate offset relative to the window's top-left
                offsetX = e.clientX - r.left;
                offsetY = e.clientY - r.top;
                
                movableWindow.classList.add('dragging');
            });
        }

        document.addEventListener("mousemove", e => {
            if (!isDragging) return;
            e.preventDefault(); // Prevent text selection

            // Update position in pixels
            movableWindow.style.left = (e.clientX - offsetX) + "px";
            movableWindow.style.top = (e.clientY - offsetY) + "px";
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                movableWindow.classList.remove('dragging');
                
                // Optional: restore transition for future fades, but keep transform: none
                movableWindow.style.transition = ''; 
            }
        });
    }

    // Scoreboard Logic
    const scoreBtn = document.getElementById('score_button');
    const scoreModal = document.getElementById('score_modal');
    const closeScore = document.getElementById('close_score');
    const scoreList = document.getElementById('score_list');

    if (scoreBtn && scoreModal) {
        scoreBtn.addEventListener('click', async () => {
            scoreModal.style.display = 'flex';
            scoreList.innerHTML = '<p>Loading scores...</p>';

            try {
                const res = await fetch('/score.json');
                if (res.ok) {
                    const data = await res.json();
                    
                    // Filter users who have a score
                    const scoredUsers = data.filter(u => u.score !== undefined);
                    
                    // Sort by score (asc) then date (desc)
                    scoredUsers.sort((a, b) => (a.score - b.score) || new Date(b.time) - new Date(a.time));

                    if (scoredUsers.length === 0) {
                        scoreList.innerHTML = '<p>No scores yet! Be the first!</p>';
                        return;
                    }

                    scoreList.innerHTML = scoredUsers.map((u, i) => `
                        <div style="
                            display: flex; justify-content: space-between; align-items: center;
                            padding: 10px; background: #f8f9fa; border-radius: 8px;
                            border: 1px solid #eee;
                        ">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: bold; color: #ff6b6b; width: 20px;">#${i+1}</span>
                                <div style="text-align: left;">
                                    <div style="font-weight: bold; color: #333;">${u.username}</div>
                                    <div style="font-size: 0.8rem; color: #666;">${u.type || 'Unknown'}</div>
                                </div>
                            </div>
                            <div style="font-weight: bold; color: #4ecdc4;">${u.score}s</div>
                        </div>
                    `).join('');
                } else {
                    scoreList.innerHTML = '<p>Failed to load scores.</p>';
                }
            } catch (e) {
                console.error(e);
                scoreList.innerHTML = '<p>Error loading scores.</p>';
            }
        });

        closeScore.addEventListener('click', () => {
            scoreModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === scoreModal) {
                scoreModal.style.display = 'none';
            }
        });
    }
    
</script>
</body>
</html>
